name: Update Draft Release

on:
  push:
    branches:
      - main

jobs:
  update-draft-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract commit messages
        run: |
          git log -1 --pretty=format:"%h %s" > commit_message.txt
        id: get_commit

      - name: Update Draft Release
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.MINE_TOKEN }} # 显式使用 GITHUB_TOKEN
          script: |
            const fs = require('fs');
            const commitMessage = fs.readFileSync('commit_message.txt', 'utf-8');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 获取现有的 Draft Release
            const releases = await github.rest.repos.listReleases({ owner, repo });
            let draftRelease = releases.data.find(r => r.draft);

            if (!draftRelease) {
              // 获取最新的published release来生成changelog和contributors
              const sortedReleases = releases.data.filter(r => !r.draft).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              const previousTag = sortedReleases.length > 0 ? sortedReleases[0].tag_name : null;
              
              let changelogContent = '';
              let contributorsContent = '';
              
              if (previousTag) {
                // 生成Full Changelog链接
                changelogContent = `\n\n**Full Changelog**: https://github.com/${owner}/${repo}/compare/${previousTag}...HEAD`;
                
                // 获取contributors
                try {
                  const comparison = await github.rest.repos.compareCommits({
                    owner,
                    repo,
                    base: previousTag,
                    head: 'main'
                  });
                  
                  const contributors = new Set();
                  comparison.data.commits.forEach(commit => {
                    if (commit.author && commit.author.login) {
                      contributors.add(commit.author.login);
                    }
                    if (commit.committer && commit.committer.login && commit.committer.login !== 'web-flow') {
                      contributors.add(commit.committer.login);
                    }
                  });
                  
                  if (contributors.size > 0) {
                    contributorsContent = '\n\n**Contributors:**\n' + Array.from(contributors).map(username => `@${username}`).join(', ');
                  }
                } catch (error) {
                  console.log('Could not generate contributors list:', error.message);
                }
              }
              
              // 如果没有 Draft Release，则创建一个新的
              const newRelease = await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: 'next-release', // 可修改为更有意义的 tag 名称
                name: 'Next Release',    // Release 的标题
                body: `### Changes:\n- ${commitMessage}${changelogContent}${contributorsContent}`,
                draft: true,
              });
              draftRelease = newRelease.data;
            } else {
              // 解析现有的 Draft Release 内容
              let existingBody = draftRelease.body;
              let changelogSection = '';

              // 提取变更列表部分（### Changes: 到第一个 ** 之前，或到文档末尾）
              const changesMatch = existingBody.match(/(### Changes:[\s\S]*?)(?=\n\n\*\*|$)/);
              if (changesMatch) {
                changelogSection = changesMatch[1];
              } else {
                // 如果没有找到，整个 body 就是变更列表
                changelogSection = existingBody;
              }

              // 解析现有的提交列表并添加新的提交
              let newChangelog = '### Changes:\n';
              const existingCommits = changelogSection.match(/^- [a-f0-9]+ .*$/gm) || [];

              // 检查新提交是否已存在（通过哈希值判断）
              const newCommitHash = commitMessage.match(/^([a-f0-9]+)/)?.[1];
              const isDuplicate = newCommitHash && existingCommits.some(commit =>
                commit.match(/^- ([a-f0-9]+)/)?.[1] === newCommitHash
              );

              // 如果不是重复提交，则添加
              if (!isDuplicate) {
                existingCommits.push(`- ${commitMessage}`);
              }

              // 按时间顺序添加所有提交（不排序，保持原有顺序）
              existingCommits.forEach(commit => {
                newChangelog += `${commit}\n`;
              });

              // 重新生成 Full Changelog 和 Contributors（每次都刷新）
              const sortedReleases = releases.data.filter(r => !r.draft).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              const previousTag = sortedReleases.length > 0 ? sortedReleases[0].tag_name : null;

              let changelogContent = '';
              let contributorsContent = '';

              if (previousTag) {
                // 生成 Full Changelog 链接
                changelogContent = `\n\n**Full Changelog**: https://github.com/${owner}/${repo}/compare/${previousTag}...HEAD`;

                // 重新获取所有 contributors
                try {
                  const comparison = await github.rest.repos.compareCommits({
                    owner,
                    repo,
                    base: previousTag,
                    head: 'main'
                  });

                  const contributors = new Set();
                  comparison.data.commits.forEach(commit => {
                    if (commit.author && commit.author.login) {
                      contributors.add(commit.author.login);
                    }
                    if (commit.committer && commit.committer.login && commit.committer.login !== 'web-flow') {
                      contributors.add(commit.committer.login);
                    }
                  });

                  if (contributors.size > 0) {
                    contributorsContent = '\n\n**Contributors:**\n' + Array.from(contributors).map(username => `@${username}`).join(', ');
                  }
                } catch (error) {
                  console.log('Could not generate contributors list:', error.message);
                }
              }

              // 组合成新的 body（使用重新生成的 Full Changelog 和 Contributors）
              const newBody = newChangelog + changelogContent + contributorsContent;

              // 更新 Draft Release
              await github.rest.repos.updateRelease({
                owner,
                repo,
                release_id: draftRelease.id,
                body: newBody,
              });
            }

            console.log('Draft Release updated successfully!');
